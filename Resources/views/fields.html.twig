{% block dependent_filtered_entity_widget %}

    <select {{ block('widget_attributes') }} class="form-control" disabled></select>

    <script type="text/javascript">
        jQuery(function(){

            var types = [
                // Used to find any field matching the exact ID returned by the backend. Only one instance of this field
                // should exist within the DOM.
                "{{ form.parent.offsetGet( parent_field ).vars.id }}",
                // Find all select types including default EntityType and additional Sonata types like ModelType
                // Original default
                "select#{{ form.parent.offsetGet( parent_field ).vars.id }}",
                // Support for the Sonata ModelAutocompleteType. Field ID differs from the one returned by the backend
                // therefore the below is necessary to find and watch it.
                "{{ form.parent.offsetGet( parent_field ).vars.id }}" + '_autocomplete_input',
            ]

            types.forEach(function (type) {
                // Where an element in the DOM with the ID exists, add an event listener to perform the dependent
                // select AJAX call.
                if (document.getElementById(type)) {
                    jQuery('#' + type).change(function () {
                        onInputChange(jQuery(this));
                    });
                }
            });

            function onInputChange(element) {
                // Keeps a field in a disabled state if the value is empty to prevent issues saving
                if (!jQuery(element).val()) {
                    return;
                }

                var selected_index = {{ value ? value : 0 }};
                jQuery.ajax({
                    type: "POST",
                    data: {
                        parent_id: jQuery(element).val(),
                        {% if fallback_parent_field is not null %}
                        fallback_parent_id: jQuery("#{{ form.parent.offsetGet( fallback_parent_field ).vars.id }}").val(),
                        {% endif %}
                        entity_alias: "{{ entity_alias }}",
                        empty_value: "{{ empty_value }}",
                        excluded_entity_id: "{{ excluded_entity_id }}",
                        choice_translation_domain: "{{ choice_translation_domain }}",
                        choice_title_translation_part: "{{ choice_title_translation_part }}",
                        callback_parameters: '{{ callback_parameters|json_encode|raw }}'
                    },
                    url:"{{ path('dependent_select') }}",
                    success: function(msg){
                        if (msg != ''){
                            jQuery("select#{{ form.vars.id }}").get(0).disabled = false;
                            jQuery("select#{{ form.vars.id }}").html(msg).show();
                            jQuery.each(jQuery("select#{{ form.vars.id }} option"), function (index, option){
                                if (jQuery(option).val() == selected_index)
                                    jQuery(option).prop('selected', true);
                            });
                            jQuery("select#{{ form.vars.id }}").trigger('change');
                        } else {
                            jQuery("select#{{ form.vars.id }}").html('<em>{{ no_result_msg|trans() }}</em>');
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        jQuery('html').html(xhr.responseText);
                    }
                });
            }

            jQuery("select#{{ form.parent.offsetGet( parent_field ).vars.id }}").trigger('change', onInputChange(this));
        });
    </script>

{% endblock %}
